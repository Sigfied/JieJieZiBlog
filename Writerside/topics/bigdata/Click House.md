# Click house 
Created by: Jie Jie Zi
Created time: October 23, 2023 2:38 PM
Tags: Engineering

## 特性

- **列式存储**
    - 对于列的聚合、计数、求和等统计操作优于**行式存储**
    - 由于**某一列的数据类型都是相同的**，针对于**数据存储更容易进行数据压缩**，每一列选择更优的数据压缩算法，大大提高了数据的压缩比重
    - 数据压缩比更好，一方面**节省了磁盘空间**，另一方面对**于cache也有了更大的发挥空间**
    - 列式存储不支持事务
- **DBMS功能**
    - 覆盖大部分SQL语法，包括 DDL 和 DML、，以及配套的各种函数；用户管理及权限管理、数据的备份与恢复
- **高吞吐写入能力**
    - ClickHouse采用类LSM Tree的结构，**数据写入后定期在后台Compaction**。通过类 LSM tree的结构， ClickHouse**在数据导入时全部是顺序append写**，写入后数据段不可更改，在后台compaction时也是多个段merge sort后顺序写回磁盘。顺序写的特性，充分利用了磁盘的吞吐能力
- **数据分区与线程及并行**
    - ClickHouse将数据划分为多个partition，每个partition再进一步划分为多个index granularity(索引粒度)，然后通过多个CPU核心分别处理其中的一部分来实现并行数据处理。在这种设计下， **单条 Query 就能利用整机所有 CPU**。 极致的并行处理能力，极大的降低了查询延时。
    - **弊端 : 对于单条查询使用多cpu，就不利于同时并发多条查询。所以对于高 qps 的查询业务并不是强项。**
- ****多服务器分布式处理****
    - 在ClickHouse中，数据可以保存在不同的shard上，每一个shard都由一组用于容错的replica组成，查询可以并行地在所有shard上进行处理。这些对用户来说是透明的
    

## 与MySQL对比

- 支持分布式表和多服务器分布式查询
- 列式存储
- 不支持事务
- 高吞吐写入能力
- 索引上的选择
    - Clickhouse 创建索引时选择基数相对重复较多的，使用的是稀疏索引，稀疏索引的主键可以不唯一。使用日志正文的一些内容作为主键列，来提高压缩比。B+树在并发写上会有很大的压力。
    - MySQL 创建索引是选择区别度较大的，比如使用UUID这一类唯一的区分度大的，或者自增的id列
    

## **OLAP场景的关键特征[](https://clickhouse.com/docs/zh#olapchang-jing-de-guan-jian-te-zheng)**

- 绝大多数是读请求
- 数据以相当大的批次(> 1000行)更新，而不是单行更新;或者根本没有更新。
- 已添加到数据库的数据不能修改。
- 对于读取，从数据库中提取相当多的行，但只提取列的一小部分。
- 宽表，即每个表包含着大量的列
- 查询相对较少(通常每台服务器每秒查询数百次或更少)
- 对于简单查询，允许延迟大约50毫秒
- 列中的数据相对较小：数字和短字符串(例如，每个URL 60个字节)
- 处理单个查询时需要高吞吐量(每台服务器每秒可达数十亿行)
- 事务不是必须的
- 对数据一致性要求低
- 每个查询有一个大表。除了他以外，其他的都很小。
- 查询结果明显小于源数据。换句话说，数据经过过滤或聚合，因此结果适合于单个服务器的RAM中

很容易可以看出，OLAP场景与其他通常业务场景(例如,OLTP或K/V)有很大的不同， 因此想要使用OLTP或Key-Value数据库去高效的处理分析查询场景，并不是非常完美的适用方案。例如，使用OLAP数据库去处理分析请求通常要优于使用MongoDB或Redis去处理分析请求。